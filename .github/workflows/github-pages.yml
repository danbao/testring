name: Deploy to GitHub Pages

on:
  push:
    branches: [ main, master, fix-testring-dev-publish ]
    paths:
      - 'docs/**'
      - 'packages/e2e-test-app/static-fixtures/**'
      - '.github/workflows/github-pages.yml'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

# è®¾ç½® GITHUB_TOKEN æƒé™ä»¥å…è®¸éƒ¨ç½²åˆ° GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# åªå…è®¸ä¸€ä¸ªå¹¶å‘éƒ¨ç½²ï¼Œè·³è¿‡æ­£åœ¨è¿›è¡Œçš„è¿è¡Œä¹‹é—´æŽ’é˜Ÿçš„è¿è¡Œ
# ä½†æ˜¯ï¼Œä¸è¦å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„è¿è¡Œï¼Œå› ä¸ºæˆ‘ä»¬å¸Œæœ›è¿™äº›ç”Ÿäº§éƒ¨ç½²å®Œæˆ
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # æž„å»ºå·¥ä½œ
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: true
          cache-version: 0

      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v4

      - name: Sync static fixtures to docs
        run: |
          echo "ðŸ“ Syncing static fixtures to docs..."
          # ç¡®ä¿ç›®å½•å­˜åœ¨
          mkdir -p docs/static-fixtures
          
          # åŒæ­¥é™æ€æ–‡ä»¶ï¼ˆå¦‚æžœæºæ–‡ä»¶æ›´æ–°çš„è¯ï¼‰
          if [ -d "packages/e2e-test-app/static-fixtures" ]; then
            echo "ðŸ”„ Copying static fixtures..."
            cp -r packages/e2e-test-app/static-fixtures/* docs/static-fixtures/
            echo "âœ… Static fixtures synced"
          else
            echo "âš ï¸  Source static-fixtures directory not found"
          fi
          
          # åˆ—å‡ºæ–‡ä»¶
          echo "ðŸ“‹ Files in docs/static-fixtures:"
          ls -la docs/static-fixtures/ || echo "Directory is empty"

      - name: Create Gemfile for Jekyll
        run: |
          cat > docs/Gemfile << 'EOF'
          source "https://rubygems.org"
          
          gem "jekyll", "~> 4.3"
          gem "minima", "~> 2.5"
          gem "jekyll-feed", "~> 0.12"
          gem "jekyll-sitemap", "~> 1.4"
          gem "jekyll-seo-tag", "~> 2.8"
          
          # Windows and JRuby does not include zoneinfo files
          gem "tzinfo", ">= 1", "< 3"
          gem "tzinfo-data", platforms: [:mingw, :mswin, :x64_mingw, :jruby]
          
          # Performance-booster for watching directories on Windows
          gem "wdm", "~> 0.1.1", :platforms => [:mingw, :mswin, :x64_mingw, :jruby]
          
          # Lock `http_parser.rb` gem to `v0.6.x` on JRuby builds
          gem "http_parser.rb", "~> 0.6.0", :platforms => [:jruby]
          EOF

      - name: Install dependencies
        run: |
          cd docs
          bundle install

      - name: Build with Jekyll
        run: |
          cd docs
          bundle exec jekyll build --baseurl "${{ steps.pages.outputs.base_path }}"
        env:
          JEKYLL_ENV: production

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/_site

  # éƒ¨ç½²å·¥ä½œ
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Display deployment info
        run: |
          echo "ðŸš€ Deployment completed!"
          echo "ðŸ“„ Site URL: ${{ steps.deployment.outputs.page_url }}"
          echo "ðŸ§ª Static fixtures: ${{ steps.deployment.outputs.page_url }}static-fixtures/"
          echo "ðŸ“š Documentation: ${{ steps.deployment.outputs.page_url }}" 